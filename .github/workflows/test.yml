name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 2am UTC
    - cron: '0 2 * * *'

permissions:
  contents: read

concurrency:
  group: snowflake-tests
  cancel-in-progress: false

env:
  REGISTRY: registry.nordquant.com
  IMAGE_NAME: dbt-bootcamp-setup

jobs:
  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run integration tests
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USERNAME: ${{ secrets.SNOWFLAKE_USERNAME }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: uv run pytest tests/test_full_flow.py -v -s --timeout=600

  build-test-push:
    name: Build, Test & Push Docker Image
    runs-on: ubuntu-latest
    needs: integration-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test
          cache-from: |
            type=local,src=/tmp/.buildx-cache
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Test Docker image
        run: |
          # Start the app
          docker run -d --name test-app \
            -p 8501:8501 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test

          # Wait for app to be healthy
          echo "Waiting for app to be healthy..."
          for i in {1..30}; do
            if docker inspect --format='{{.State.Health.Status}}' test-app 2>/dev/null | grep -q "healthy"; then
              echo "App is healthy!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "App failed to become healthy"
              docker logs test-app
              exit 1
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

          # Test health endpoint
          echo "Testing health endpoint..."
          curl -f http://localhost:8501/healthz || exit 1

          # Test main page contains "Snowflake"
          echo "Testing main page..."
          curl -f http://localhost:8501/ | grep -q "Snowflake" || exit 1

          echo "All tests passed!"

          # Cleanup
          docker stop test-app
          docker rm test-app

      - name: Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          build-args: |
            GIT_COMMIT=${{ github.sha }}
          cache-from: |
            type=local,src=/tmp/.buildx-cache-new
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Image pushed successfully
        run: |
          echo "Image pushed to ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "Image also tagged as ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
